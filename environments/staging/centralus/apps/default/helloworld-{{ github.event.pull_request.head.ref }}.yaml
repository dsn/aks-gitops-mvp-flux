
---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    istio-injection: enabled
  name: feature-demo-pipeline

---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: helloworld-{{ github.event.pull_request.head.ref }}
  namespace: feature-demo-pipeline
  annotations:
    fluxcd.io/automated: "true"
    filter.fluxcd.io/chart-image: glob:feature-demo-pipeline-*
spec:
  releaseName: helloworld-{{ github.event.pull_request.head.ref }}
  chart:
    git: git@github.com:haisumb/aks-gitops-mvp-flux
    path: environments/staging/centralus/charts/generic
    ref: master
  rollback:
    # If set, will perform rollbacks for this release.
    enable: true
    # If set, will force resource update through delete/recreate if
    # needed.
    force: false
    # Prevent hooks from running during rollback.
    disableHooks: true
    # Time in seconds to wait for any individual Kubernetes operation.
    timeout: 300
    # If set, will wait until all Pods, PVCs, Services, and minimum
    # number of Pods of a Deployment are in a ready state before
    # marking the release as successful. It will wait for as long
    # as the set timeout.
    wait: true
  values:
    image:
      repository: haisumb/helloworld
      tag: feature-demo-pipeline-843fda57a18f69e989f27ab42d02140eeb662927
    fullnameOverride: helloworld-{{ github.event.pull_request.head.ref }}
    nameOverride: helloworld-{{ github.event.pull_request.head.ref }}
    replicaCount: 
    canary:
      enabled: true
      loadtest:
        enabled: true
      # Enable when we have helm tests
      helmtest:
        enabled: false
      istioIngress:
        enabled: true
        gateway: public-gateway.istio-system.svc.cluster.local
        host: feature-demo-pipeline.prod.helloworld.com
      bluegreen:
        enabled: false
      confirm:
        rollback:
          status: halt
        promotion:
          enabled: false
          status: approve
